
---
# cloud-run-events-core.yaml
# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: v1
kind: Namespace
metadata:
  name: cloud-run-events
  labels:
    events.cloud.google.com/release: "v0.13.0"

---
# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: v1
kind: ServiceAccount
metadata:
  name: controller
  namespace: cloud-run-events
  labels:
    events.cloud.google.com/release: "v0.13.0"
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: webhook
  namespace: cloud-run-events
  labels:
    events.cloud.google.com/release: "v0.13.0"

---
# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Use this aggregated ClusterRole when you need readonly access to "Addressables".

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: addressable-resolver
  labels:
    events.cloud.google.com/release: "v0.13.0"
aggregationRule:
  clusterRoleSelectors:
  - matchLabels:
      duck.knative.dev/addressable: "true"
rules: []
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: service-addressable-resolver
  labels:
    events.cloud.google.com/release: "v0.13.0"
    duck.knative.dev/addressable: "true"
# Do not use this role directly. These rules will be added to the "addressable-resolver" role.
rules:
- apiGroups:
  - ""
  resources:
  - services
  - services/status
  verbs:
  - get
  - list
  - watch
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: kservice-addressable-resolver
  labels:
    events.cloud.google.com/release: "v0.13.0"
    duck.knative.dev/addressable: "true"
# Do not use this role directly. These rules will be added to the "addressable-resolver" role.
rules:
- apiGroups:
  - serving.knative.dev
  resources:
  - services
  - services/status
  - routes
  - routes/status
  verbs:
  - get
  - list
  - watch
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: pubsub-topic-addressable-resolver
  labels:
    events.cloud.google.com/release: "v0.13.0"
    duck.knative.dev/addressable: "true"
# Do not use this role directly. These rules will be added to the "addressable-resolver" role.
rules:
- apiGroups:
  - pubsub.cloud.google.com
  resources:
  - topics
  - topics/status
  verbs:
  - get
  - list
  - watch
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: events-channel-addressable-resolver
  labels:
    events.cloud.google.com/release: "v0.13.0"
    duck.knative.dev/addressable: "true"
# Do not use this role directly. These rules will be added to the "addressable-resolver" role.
rules:
- apiGroups:
  - messaging.cloud.google.com
  resources:
  - channels
  - channels/status
  verbs:
  - get
  - list
  - watch

---
# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Use this aggregated ClusterRole when you nead and update permissions on "Channelables".

kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: events-channel-channelable-manipulator
  labels:
    events.cloud.google.com/release: "v0.13.0"
    duck.knative.dev/channelable: "true"
# Do not use this role directly. These rules will be added to the "channelable-manipulator" role.
rules:
- apiGroups:
  - messaging.cloud.google.com
  resources:
  - channels
  - channels/status
  verbs:
  - create
  - get
  - list
  - watch
  - update
  - patch

---
# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cloud-run-events-controller
  labels:
    events.cloud.google.com/release: "v0.13.0"
rules:
- apiGroups:
  - pubsub.cloud.google.com
  resources:
  - pullsubscriptions
  - topics
  verbs: &everything
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
- apiGroups:
  - pubsub.cloud.google.com
  resources:
  - pullsubscriptions/status
  - topics/status
  verbs:
  - get
  - update
  - patch
- apiGroups:
  - messaging.cloud.google.com
  resources:
  - channels
  verbs: *everything
- apiGroups:
  - messaging.cloud.google.com
  resources:
  - channels/status
  verbs:
  - get
  - update
  - patch
- apiGroups:
  - events.cloud.google.com
  resources:
  - cloudauditlogssources
  - cloudstoragesources
  - cloudschedulersources
  - cloudpubsubsources
  verbs: *everything
- apiGroups:
  - events.cloud.google.com
  resources:
  - cloudauditlogssources/status
  - cloudstoragesources/status
  - cloudschedulersources/status
  - cloudpubsubsources/status
  verbs:
  - get
  - update
  - patch
- apiGroups:
  - apps
  resources:
  - deployments
  verbs: *everything
- apiGroups:
  - serving.knative.dev
  resources:
  - services
  verbs: *everything
- apiGroups:
  - batch
  resources:
  - jobs
  verbs: *everything
- apiGroups:
  - ""
  resources:
  - services
  verbs: *everything
- apiGroups:
  - ""
  resources:
  - configmaps
  - pods # For reading termination messages
  - secrets
  verbs: &readOnly
  - get
  - list
  - watch
- apiGroups: [""]
  resources:
  - events
  verbs:
  - create
  - patch
- apiGroups:
  - eventing.knative.dev
  resources:
  - eventtypes
  verbs: *everything
- apiGroups:
  - keda.k8s.io
  resources:
  - scaledobjects
  verbs: *everything
- apiGroups:
  - coordination.k8s.io
  resources:
  - leases
  verbs: *everything
---
# The role is needed for the aggregated role source-observer in knative-eventing to provide readonly access to "Sources".
# See https://github.com/knative/eventing/blob/master/config/200-source-observer-clusterrole.yaml.
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: knative-gcp-sources-observer
  labels:
    eventing.knative.dev/release: devel
    duck.knative.dev/source: "true"
rules:
- apiGroups:
  - "events.cloud.google.com"
  resources:
  - "cloudstoragesources"
  - "cloudpubsubsources"
  - "cloudauditlogssources"
  - "cloudschedulersources"
  verbs:
  - get
  - list
  - watch

---
# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: cloud-run-events-controller
  namespace: cloud-run-events
  labels:
    events.cloud.google.com/release: "v0.13.0"
rules:
- apiGroups:
  - ""
  resources:
  - secrets
  - configmaps
  verbs: &everything
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete

---
# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: cloud-run-events-webhook
  labels:
    events.cloud.google.com/release: "v0.13.0"
rules:
- # For watching logging configuration and getting certs.
  apiGroups:
  - ""
  resources:
  - "configmaps"
  verbs:
  - "get"
  - "list"
  - "watch"
- # For manipulating certs into secrets.
  apiGroups:
  - ""
  resources:
  - "secrets"
  verbs:
  - "get"
  - "create"
  - "update"
  - "list"
  - "watch"
- # For getting our Deployment so we can decorate with ownerref.
  apiGroups:
  - "apps"
  resources:
  - "deployments"
  verbs:
  - "get"
- apiGroups:
  - "apps"
  resources:
  - "deployments/finalizers"
  verbs:
  - update
- # For actually registering our webhook.
  apiGroups:
  - "admissionregistration.k8s.io"
  resources:
  - "mutatingwebhookconfigurations"
  - "validatingwebhookconfigurations"
  verbs:
  - "get"
  - "list"
  - "create"
  - "update"
  - "delete"
  - "patch"
  - "watch"

---
# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cloud-run-events-controller
  labels:
    events.cloud.google.com/release: "v0.13.0"
subjects:
- kind: ServiceAccount
  name: controller
  namespace: cloud-run-events
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cloud-run-events-controller
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cloud-run-events-controller-resolver
  labels:
    events.cloud.google.com/release: "v0.13.0"
subjects:
- kind: ServiceAccount
  name: controller
  namespace: cloud-run-events
# An aggregated ClusterRole for all Addressable CRDs. 
# Ref: https://github.com/knative/eventing/blob/master/config/200-addressable-resolvers-clusterrole.yaml
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: addressable-resolver
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: cloud-run-events-webhook
  labels:
    events.cloud.google.com/release: "v0.13.0"
subjects:
- kind: ServiceAccount
  name: webhook
  namespace: cloud-run-events
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cloud-run-events-webhook

---
# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: cloud-run-events-controller
  namespace: cloud-run-events
  labels:
    events.cloud.google.com/release: "v0.13.0"
subjects:
- kind: ServiceAccount
  name: controller
  namespace: cloud-run-events
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: cloud-run-events-controller

---
# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: channels.messaging.cloud.google.com
  labels:
    events.cloud.google.com/release: "v0.13.0"
    events.cloud.google.com/crd-install: "true"
    messaging.knative.dev/subscribable: "true"
    duck.knative.dev/addressable: "true"
spec:
  group: messaging.cloud.google.com
  version: v1alpha1
  names:
    kind: Channel
    plural: channels
    singular: channel
    categories:
    - all
    - knative
    - pubsub
    - messaging
    - channel
    shortNames:
    - pschan
  scope: Namespaced
  subresources:
    status: {}
  additionalPrinterColumns:
  - name: Ready
    type: string
    JSONPath: ".status.conditions[?(@.type==\"Ready\")].status"
  - name: Reason
    type: string
    JSONPath: ".status.conditions[?(@.type==\"Ready\")].reason"
  - name: Address
    type: string
    JSONPath: .status.address.url
  - name: Age
    type: date
    JSONPath: .metadata.creationTimestamp
  validation:
    openAPIV3Schema:
      properties:
        spec:
          properties:
            secret:
              type: object
              description: "Credential to use to manage Cloud Pub/Sub. The value of
                the secret entry must be a service account key in the JSON format
                (see https://cloud.google.com/iam/docs/creating-managing-service-account-keys).
                Defaults to secret.name of 'google-cloud-key' and secret.key of 'key.json'."
            project:
              type: string
              description: "ID of the Google Cloud Project to own the Pub/Sub credentials.
                E.g. 'my-project-1234' rather than its display name, 'My Project'
                or its number '1234567890'. If omitted uses the Project ID from the
                GKE cluster metadata service."
            subscribable:
              type: object
              properties:
                subscribers:
                  type: array
                  items:
                    required:
                    - uid
                    properties:
                      ref:
                        type: object
                        required:
                        - namespace
                        - name
                        - uid
                        properties:
                          apiVersion:
                            type: string
                          kind:
                            type: string
                          name:
                            type: string
                            minLength: 1
                          namespace:
                            type: string
                            minLength: 1
                          uid:
                            type: string
                            minLength: 1
                      uid:
                        type: string
                        minLength: 1
                      subscriberURI:
                        type: string
                        minLength: 1
                      replyURI:
                        type: string
                        minLength: 1
        status:
          properties:
            observedGeneration:
              type: integer
              format: int64
            conditions:
              type: array
              items:
                type: object
                properties:
                  lastTransitionTime:
                    # we use a string in the stored object but a wrapper object
                    # at runtime.
                    type: string
                  message:
                    type: string
                  reason:
                    type: string
                  severity:
                    type: string
                  status:
                    type: string
                  type:
                    type: string
                required:
                - type
                - status
            subscribableStatus:
              type: object
              properties:
                subscribers:
                  type: array
                  items:
                    type: object
                    properties:
                      uid:
                        type: string
                      observedGeneration:
                        type: integer
                        format: int64
                      ready:
                        type: string
                      message:
                        type: string
            address:
              type: object
              properties:
                url:
                  type: string
            projectId:
              type: string
            subscriptionId:
              type: string
          type: object

---
# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  labels:
    duck.knative.dev/source: "true"
    events.cloud.google.com/release: "v0.13.0"
    events.cloud.google.com/crd-install: "true"
  annotations:
    registry.knative.dev/eventTypes: |
      [
        {"type": "com.google.cloud.auditlog.event", "schema": "type.googleapis.com/google.logging.v2.LogEntry", "description": "Common audit log event type for all Google Cloud Platform API operations." }
      ]
  name: cloudauditlogssources.events.cloud.google.com
spec:
  group: events.cloud.google.com
  version: v1alpha1
  names:
    categories:
    - all
    - knative
    - cloudauditlogssource
    - sources
    kind: CloudAuditLogsSource
    plural: cloudauditlogssources
  scope: Namespaced
  subresources:
    status: {}
  additionalPrinterColumns:
  - name: Ready
    type: string
    JSONPath: ".status.conditions[?(@.type==\"Ready\")].status"
  - name: Reason
    type: string
    JSONPath: ".status.conditions[?(@.type==\"Ready\")].reason"
  - name: Age
    type: date
    JSONPath: .metadata.creationTimestamp
  validation:
    openAPIV3Schema:
      properties:
        spec:
          properties:
            secret:
              type: object
              description: "Credential used to poll the Cloud Pub/Sub Subscription.
                It is not used to create or delete the Subscription, only to poll
                it. The value of the secret entry must be a service account key in
                the JSON format (see https://cloud.google.com/iam/docs/creating-managing-service-account-keys).
                Defaults to secret.name of 'google-cloud-key' and secret.key of 'key.json'."
            serviceAccountName:
              type: string
              description: "Service Account to run Receive Adapter as. If omitted,
                uses 'default'."
            project:
              type: string
              description: "Google Cloud Project ID of the project into which the
                topic should be created. If omitted uses the Project ID from the GKE
                cluster metadata service."
            serviceName:
              type: string
              description: "The GCP service providing audit logs."
            methodName:
              type: string
              description: "The name of the service method or operation. For API calls,
                this should be the name of the API method."
            resourceName:
              type: string
              description: "The resource or collection that is the target of the operation.
                The name is a scheme-less URI, not including the API service name.
                If omitted, audit log events matching service and method will be pulled
                for all resources."
            sink:
              type: object
              description: "Sink which receives the notifications."
          required:
          - sink
          - serviceName
          - methodName
        status:
          type: object
          properties:
            observedGeneration:
              type: integer
              format: int64
            conditions:
              type: array
              items:
                type: object
                properties:
                  lastTransitionTime:
                    # we use a string in the stored object but a wrapper object
                    # at runtime.
                    type: string
                  message:
                    type: string
                  reason:
                    type: string
                  severity:
                    type: string
                  status:
                    type: string
                  type:
                    type: string
                required:
                - type
                - status
            sinkUri:
              type: string
            projectId:
              type: string
            topicId:
              type: string
            stackdriverSink:
              type: string
            subscriptionId:
              type: string

---
# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  labels:
    duck.knative.dev/source: "true"
    events.cloud.google.com/release: "v0.13.0"
    events.cloud.google.com/crd-install: "true"
  annotations:
    registry.knative.dev/eventTypes: |
      [
        { "type": "com.google.cloud.pubsub.topic.publish", "description": "This event is sent when a message is published to a Cloud Pub/Sub topic."}
      ]
  name: cloudpubsubsources.events.cloud.google.com
spec:
  group: events.cloud.google.com
  version: v1alpha1
  names:
    categories:
    - all
    - knative
    - cloudpubsubsource
    - sources
    kind: CloudPubSubSource
    plural: cloudpubsubsources
  scope: Namespaced
  subresources:
    status: {}
  additionalPrinterColumns:
  - name: Ready
    type: string
    JSONPath: ".status.conditions[?(@.type==\"Ready\")].status"
  - name: Reason
    type: string
    JSONPath: ".status.conditions[?(@.type==\"Ready\")].reason"
  - name: Age
    type: date
    JSONPath: .metadata.creationTimestamp
  validation:
    openAPIV3Schema:
      properties:
        spec:
          required:
          - sink
          - topic
          properties:
            secret:
              type: object
              description: "Credential used to poll the Cloud Pub/Sub Subscription.
                It is not used to create or delete the Subscription, only to poll
                it. The value of the secret entry must be a service account key in
                the JSON format (see https://cloud.google.com/iam/docs/creating-managing-service-account-keys).
                Defaults to secret.name of 'google-cloud-key' and secret.key of 'key.json'."
            project:
              type: string
              description: "ID of the Google Cloud Project that the Pub/Sub Topic
                exists in. E.g. 'my-project-1234' rather than its display name, 'My
                Project' or its number '1234567890'. If omitted uses the Project ID
                from the GKE cluster metadata service."
            sink:
              type: object
              description: "Reference to an object that will resolve to a domain name
                to use as the sink."
              anyOf:
              - type: object
                properties:
                  uri:
                    type: string
                    minLength: 1
              - type: object
                properties:
                  ref:
                    type: object
                    required:
                    - apiVersion
                    - kind
                    - name
                    properties:
                      apiVersion:
                        type: string
                        minLength: 1
                      kind:
                        type: string
                        minLength: 1
                      name:
                        type: string
                        minLength: 1
            ceOverrides:
              type: object
              description: "Defines overrides to control modifications of the event
                sent to the sink."
              properties:
                extensions:
                  type: object
                  description: "Extensions specify what attribute are added or overridden
                    on the outbound event. Each `Extensions` key-value pair are set
                    on the event as an attribute extension independently."
            topic:
              type: string
              description: "ID of the Cloud Pub/Sub Topic to Subscribe to. It must
                be in the form of the unique identifier within the project, not the
                entire name. E.g. it must be 'laconia', not 'projects/my-gcp-project/topics/laconia'."
            ackDeadline:
              type: string
              description: "The default maximum time after a subscriber receives a
                message before the subscriber should acknowledge the message. Defaults
                to `30s`. Valid time units are `s`, `m`, `h`. The minimum deadline
                you can specify is 0 seconds. The maximum deadline you can specify
                is 600 seconds (10 minutes)."
            retainAckedMessages:
              type: boolean
              description: "Whether to retain acknowledged messages. If true, acknowledged
                messages will not be expunged until they fall out of the RetentionDuration
                window."
            retentionDuration:
              type: string
              description: "How long to retain messages in backlog, from the time
                of publish. If retainAckedMessages is true, this duration affects
                the retention of acknowledged messages, otherwise only unacknowledged
                messages are retained. Defaults to 7 days (`168h`). Cannot be longer
                than 7 days or shorter than 10 minutes. Valid time units are `s`,
                `m`, `h`."
          type: object
        status:
          properties:
            observedGeneration:
              type: integer
              format: int64
            conditions:
              items:
                properties:
                  lastTransitionTime:
                    # we use a string in the stored object but a wrapper object
                    # at runtime.
                    type: string
                  message:
                    type: string
                  reason:
                    type: string
                  severity:
                    type: string
                  status:
                    type: string
                  type:
                    type: string
                required:
                - type
                - status
                type: object
              type: array
            sinkUri:
              type: string
          type: object

---
# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  labels:
    duck.knative.dev/source: "true"
    events.cloud.google.com/release: "v0.13.0"
    events.cloud.google.com/crd-install: "true"
  annotations:
    registry.knative.dev/eventTypes: |
      [
        { "type": "com.google.cloud.scheduler.job.execute", "description": "This event is sent when a job is executed in Cloud Scheduler."}
      ]
  name: cloudschedulersources.events.cloud.google.com
spec:
  group: events.cloud.google.com
  version: v1alpha1
  names:
    categories:
    - all
    - knative
    - cloudschedulersource
    - sources
    kind: CloudSchedulerSource
    plural: cloudschedulersources
  scope: Namespaced
  subresources:
    status: {}
  additionalPrinterColumns:
  - name: Ready
    type: string
    JSONPath: ".status.conditions[?(@.type==\"Ready\")].status"
  - name: Reason
    type: string
    JSONPath: ".status.conditions[?(@.type==\"Ready\")].reason"
  - name: Age
    type: date
    JSONPath: .metadata.creationTimestamp
  validation:
    openAPIV3Schema:
      properties:
        spec:
          properties:
            secret:
              type: object
              description: "Credential used to poll the Cloud Pub/Sub Subscription.
                It is not used to create or delete the Subscription, only to poll
                it. The value of the secret entry must be a service account key in
                the JSON format (see https://cloud.google.com/iam/docs/creating-managing-service-account-keys).
                Defaults to secret.name of 'google-cloud-key' and secret.key of 'key.json'."
            project:
              type: string
              description: "Google Cloud Project ID of the project into which the
                Scheduler job should be created. If omitted uses the Project ID from
                the GKE cluster metadata service."
            location:
              type: string
              description: "Location to create the Scheduler job in."
            schedule:
              type: string
              description: "Frequency using the unix-cron format. Or App Engine Cron
                format."
            data:
              type: string
              description: "Data to send in the payload of the Event."
            sink:
              type: object
              description: "Sink which receives the notifications."
              anyOf:
              - type: object
                properties:
                  uri:
                    type: string
                    minLength: 1
              - type: object
                properties:
                  ref:
                    type: object
                    required:
                    - apiVersion
                    - kind
                    - name
                    properties:
                      apiVersion:
                        type: string
                        minLength: 1
                      kind:
                        type: string
                        minLength: 1
                      name:
                        type: string
                        minLength: 1
            ceOverrides:
              type: object
              description: "Defines overrides to control modifications of the event
                sent to the sink."
              properties:
                extensions:
                  type: object
                  description: "Extensions specify what attribute are added or overridden
                    on the outbound event. Each `Extensions` key-value pair are set
                    on the event as an attribute extension independently."
          required:
          - location
          - schedule
          - sink
          - data
        status:
          properties:
            conditions:
              items:
                properties:
                  lastTransitionTime:
                    # we use a string in the stored object but a wrapper object
                    # at runtime.
                    type: string
                  message:
                    type: string
                  reason:
                    type: string
                  severity:
                    type: string
                  status:
                    type: string
                  type:
                    type: string
                required:
                - type
                - status
                type: object
              type: array
            sinkUri:
              type: string
            projectId:
              type: string
            topicId:
              type: string
            notificationId:
              type: string
            subscriptionId:
              type: string
          type: object

---
# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  labels:
    duck.knative.dev/source: "true"
    events.cloud.google.com/release: "v0.13.0"
    events.cloud.google.com/crd-install: "true"
  annotations:
    registry.knative.dev/eventTypes: |
      [
        { "type": "com.google.cloud.storage.object.finalize", "schema": "https://raw.githubusercontent.com/google/knative-gcp/master/schemas/storage/schema.json", "description": "Sent when a new object (or a new generation of an existing object) is successfully created in the bucket. This includes copying or rewriting an existing object. A failed upload does not trigger this event." },
        { "type": "com.google.cloud.storage.object.delete", "schema": "https://raw.githubusercontent.com/google/knative-gcp/master/schemas/storage/schema.json", "description": "Sent when an object has been permanently deleted. This includes objects that are overwritten or are deleted as part of the bucket's lifecycle configuration. For buckets with object versioning enabled, this is not sent when an object is archived."},
        { "type": "com.google.cloud.storage.object.archive", "schema": "https://raw.githubusercontent.com/google/knative-gcp/master/schemas/storage/schema.json", "description": "Only sent when a bucket has enabled object versioning. This event indicates that the live version of an object has become an archived version, either because it was archived or because it was overwritten by the upload of an object of the same name."},
        { "type": "com.google.cloud.storage.object.metadataUpdate", "schema": "https://raw.githubusercontent.com/google/knative-gcp/master/schemas/storage/schema.json", "description": "Sent when the metadata of an existing object changes." }
      ]
  name: cloudstoragesources.events.cloud.google.com
spec:
  group: events.cloud.google.com
  version: v1alpha1
  names:
    categories:
    - all
    - knative
    - cloudstoragesource
    - sources
    kind: CloudStorageSource
    plural: cloudstoragesources
  scope: Namespaced
  subresources:
    status: {}
  additionalPrinterColumns:
  - name: Ready
    type: string
    JSONPath: ".status.conditions[?(@.type==\"Ready\")].status"
  - name: Reason
    type: string
    JSONPath: ".status.conditions[?(@.type==\"Ready\")].reason"
  - name: Age
    type: date
    JSONPath: .metadata.creationTimestamp
  validation:
    openAPIV3Schema:
      properties:
        spec:
          properties:
            secret:
              type: object
              description: "Credential used to poll the Cloud Pub/Sub Subscription.
                It is not used to create or delete the Subscription, only to poll
                it. The value of the secret entry must be a service account key in
                the JSON format (see https://cloud.google.com/iam/docs/creating-managing-service-account-keys).
                Defaults to secret.name of 'google-cloud-key' and secret.key of 'key.json'."
            serviceAccountName:
              type: string
              description: "Service Account to run Receive Adapter as. If omitted,
                uses 'default'."
            project:
              type: string
              description: "Google Cloud Project ID of the project into which the
                topic should be created. If omitted uses the Project ID from the GKE
                cluster metadata service."
            bucket:
              type: string
              description: "GCS bucket to subscribe to. For example my-test-bucket"
            objectNamePrefix:
              type: string
              description: "Optional prefix to only notify when objects match this
                prefix."
            payloadFormat:
              type: string
              description: "Optional payload format. Either NONE or JSON_API_V1. If
                omitted, uses JSON_API_V1."
            sink:
              type: object
              description: "Sink which receives the notifications."
              anyOf:
              - type: object
                properties:
                  uri:
                    type: string
                    minLength: 1
              - type: object
                properties:
                  ref:
                    type: object
                    required:
                    - apiVersion
                    - kind
                    - name
                    properties:
                      apiVersion:
                        type: string
                        minLength: 1
                      kind:
                        type: string
                        minLength: 1
                      name:
                        type: string
                        minLength: 1
            ceOverrides:
              type: object
              description: "Defines overrides to control modifications of the event
                sent to the sink."
              properties:
                extensions:
                  type: object
                  description: "Extensions specify what attribute are added or overridden
                    on the outbound event. Each `Extensions` key-value pair are set
                    on the event as an attribute extension independently."
            eventTypes:
              type: array
              items:
                type: string
                enum:
                - com.google.cloud.storage.object.finalize
                - com.google.cloud.storage.object.delete
                - com.google.cloud.storage.object.archive
                - com.google.cloud.storage.object.metadataUpdate
          required:
          - bucket
          - sink
        status:
          type: object
          properties:
            observedGeneration:
              type: integer
              format: int64
            conditions:
              type: array
              items:
                type: object
                properties:
                  lastTransitionTime:
                    # we use a string in the stored object but a wrapper object
                    # at runtime.
                    type: string
                  message:
                    type: string
                  reason:
                    type: string
                  severity:
                    type: string
                  status:
                    type: string
                  type:
                    type: string
                required:
                - type
                - status
            sinkUri:
              type: string
            projectId:
              type: string
            topicId:
              type: string
            notificationId:
              type: string
            subscriptionId:
              type: string

---
# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  labels:
    events.cloud.google.com/release: "v0.13.0"
    events.cloud.google.com/crd-install: "true"
  name: pullsubscriptions.pubsub.cloud.google.com
spec:
  group: pubsub.cloud.google.com
  version: v1alpha1
  names:
    categories:
    - all
    - knative
    - pubsub
    kind: PullSubscription
    plural: pullsubscriptions
  scope: Namespaced
  subresources:
    status: {}
  additionalPrinterColumns:
  - name: Ready
    type: string
    JSONPath: ".status.conditions[?(@.type==\"Ready\")].status"
  - name: Reason
    type: string
    JSONPath: ".status.conditions[?(@.type==\"Ready\")].reason"
  - name: Age
    type: date
    JSONPath: .metadata.creationTimestamp
  validation:
    openAPIV3Schema:
      properties:
        spec:
          # TODO: update the OpenAPI to be much more robust.
          required:
          - sink
          - topic
          properties:
            secret:
              type: object
              description: "Credential used to poll the Cloud Pub/Sub Subscription.
                It is not used to create or delete the Subscription, only to poll
                it. The value of the secret entry must be a service account key in
                the JSON format (see https://cloud.google.com/iam/docs/creating-managing-service-account-keys).
                Defaults to secret.name of 'google-cloud-key' and secret.key of 'key.json'."
            project:
              type: string
              description: "ID of the Google Cloud Project that the Pub/Sub Topic
                exists in. E.g. 'my-project-1234' rather than its display name, 'My
                Project' or its number '1234567890'. If omitted uses the Project ID
                from the GKE cluster metadata service."
            sink:
              type: object
              description: "Reference to an object that will resolve to a domain name
                to use as the sink."
              anyOf:
              - type: object
                properties:
                  uri:
                    type: string
                    minLength: 1
              - type: object
                properties:
                  ref:
                    type: object
                    required:
                    - apiVersion
                    - kind
                    - name
                    properties:
                      apiVersion:
                        type: string
                        minLength: 1
                      kind:
                        type: string
                        minLength: 1
                      name:
                        type: string
                        minLength: 1
            transformer:
              type: object
              description: "Reference to an object that will resolve to a domain name
                to use as the transformer."
            ceOverrides:
              type: object
              description: "Defines overrides to control modifications of the event
                sent to the sink."
              properties:
                extensions:
                  type: object
                  description: "Extensions specify what attribute are added or overridden
                    on the outbound event. Each `Extensions` key-value pair are set
                    on the event as an attribute extension independently."
            mode:
              type: string
              enum: [CloudEventsBinary, CloudEventsStructured, PushCompatible]
              description: "Mode defines the encoding and structure of the payload
                of when this PullSubscription invokes the sink. Default is CloudEventsBinary."
            topic:
              type: string
              description: "ID of the Cloud Pub/Sub Topic to Subscribe to. It must
                be in the form of the unique identifier within the project, not the
                entire name. E.g. it must be 'laconia', not 'projects/my-gcp-project/topics/laconia'."
            ackDeadline:
              type: string
              description: "The default maximum time after a subscriber receives a
                message before the subscriber should acknowledge the message. Defaults
                to `30s`. Valid time units are `s`, `m`, `h`. The minimum deadline
                you can specify is 0 seconds. The maximum deadline you can specify
                is 600 seconds (10 minutes)."
            retainAckedMessages:
              type: boolean
              description: "Whether to retain acknowledged messages. If true, acknowledged
                messages will not be expunged until they fall out of the RetentionDuration
                window."
            retentionDuration:
              type: string
              description: "How long to retain messages in backlog, from the time
                of publish. If retainAckedMessages is true, this duration affects
                the retention of acknowledged messages, otherwise only unacknowledged
                messages are retained. Defaults to 7 days (`168h`). Cannot be longer
                than 7 days or shorter than 10 minutes. Valid time units are `s`,
                `m`, `h`."
          type: object
        status:
          properties:
            observedGeneration:
              type: integer
              format: int64
            conditions:
              items:
                properties:
                  lastTransitionTime:
                    # we use a string in the stored object but a wrapper object
                    # at runtime.
                    type: string
                  message:
                    type: string
                  reason:
                    type: string
                  severity:
                    type: string
                  status:
                    type: string
                  type:
                    type: string
                required:
                - type
                - status
                type: object
              type: array
            sinkUri:
              type: string
            transformerUri:
              type: string
            projectId:
              type: string
            subscriptionId:
              type: string
          type: object

---
# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: topics.pubsub.cloud.google.com
  labels:
    events.cloud.google.com/release: "v0.13.0"
    events.cloud.google.com/crd-install: "true"
    duck.knative.dev/addressable: "true"
spec:
  group: pubsub.cloud.google.com
  version: v1alpha1
  names:
    kind: Topic
    plural: topics
    singular: topic
    categories:
    - all
    - knative
    - pubsub
  scope: Namespaced
  subresources:
    status: {}
  additionalPrinterColumns:
  - name: Ready
    type: string
    JSONPath: ".status.conditions[?(@.type==\"Ready\")].status"
  - name: Reason
    type: string
    JSONPath: ".status.conditions[?(@.type==\"Ready\")].reason"
  - name: Address
    type: string
    JSONPath: .status.address.url
  - name: Age
    type: date
    JSONPath: .metadata.creationTimestamp
  validation:
    openAPIV3Schema:
      properties:
        spec:
          required:
          - topic
          properties:
            secret:
              type: object
              description: "Credential to use to manage Cloud Pub/Sub. The value of
                the secret entry must be a service account key in the JSON format
                (see https://cloud.google.com/iam/docs/creating-managing-service-account-keys).
                If omitted, defaults to 'google-cloud-key'."
            project:
              type: string
              description: "ID of the Google Cloud Project to own the Pub/Sub credentials.
                E.g. 'my-project-1234' rather than its display name, 'My Project'
                or its number '1234567890'. If omitted uses the Project ID from the
                GKE cluster metadata service."
            topic:
              type: string
              description: "ID of the Cloud Pub/Sub Topic to create. It must be in
                the form of the unique identifier within the project, not the entire
                name. E.g. it must be 'laconia', not 'projects/my-gcp-project/topics/laconia'."
            propagationPolicy:
              type: string
              enum: [CreateDelete, CreateNoDelete, NoCreateNoDelete]
              description: "Propagation policy defines how Topic controls the Cloud
                Pub/Sub topic for lifecycle changes. Default is CreateNoDelete."
        status:
          type: object
          properties:
            observedGeneration:
              type: integer
              format: int64
            conditions:
              type: array
              items:
                type: object
                properties:
                  lastTransitionTime:
                    # we use a string in the stored object but a wrapper object
                    # at runtime.
                    type: string
                  message:
                    type: string
                  reason:
                    type: string
                  severity:
                    type: string
                  status:
                    type: string
                  type:
                    type: string
                required:
                - type
                - status
            projectId:
              type: string
            topicId:
              type: string
            address:
              type: object
              properties:
                url:
                  type: string

---
# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: v1
kind: Service
metadata:
  name: controller
  namespace: cloud-run-events
  labels:
    events.cloud.google.com/release: "v0.13.0"
    app: cloud-run-events-controller
spec:
  selector:
    app: cloud-run-events-controller
  ports:
  - name: metrics
    port: 9090
    protocol: TCP
    targetPort: 9090

---
# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: v1
kind: Service
metadata:
  labels:
    role: webhook
    events.cloud.google.com/release: "v0.13.0"
  name: webhook
  namespace: cloud-run-events
spec:
  ports:
  - port: 443
    targetPort: 8443
  selector:
    role: webhook

---
# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: apps/v1
kind: Deployment
metadata:
  name: controller
  namespace: cloud-run-events
  labels:
    events.cloud.google.com/release: "v0.13.0"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cloud-run-events
      role: controller
  template:
    metadata:
      labels:
        app: cloud-run-events
        role: controller
    spec:
      serviceAccountName: controller
      containers:
      - name: controller
        image: gcr.io/knative-releases/github.com/google/knative-gcp/cmd/controller@sha256:e349b829d33f0f45022526ed22541e4d4ba76dde28c5c36950881f5241a5d76d
        imagePullPolicy: Always
        env:
        - name: GOOGLE_APPLICATION_CREDENTIALS
          value: /var/secrets/google/key.json
        - name: PUBSUB_RA_IMAGE
          value: gcr.io/knative-releases/github.com/google/knative-gcp/cmd/pubsub/receive_adapter@sha256:9e7cd80f6d97a2fd56c4e1c84b7b43a0c5f1036b4b004c6a1c0819bf4d37b5f3
        - name: PUBSUB_PUBLISHER_IMAGE
          value: gcr.io/knative-releases/github.com/google/knative-gcp/cmd/pubsub/publisher@sha256:c5dc012e521eb91653c5dc8dcb6b4e513d9a2a832a413122c48ecb63a2b14cc2
        - name: SYSTEM_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: CONFIG_LOGGING_NAME
          value: config-logging
        - name: CONFIG_OBSERVABILITY_NAME
          value: config-observability
        - name: CONFIG_LEADERELECTION_NAME
          value: config-leader-election
        - name: METRICS_DOMAIN
          value: cloud.google.com/events
        volumeMounts:
        - name: google-cloud-key
          mountPath: /var/secrets/google
        - name: config-logging
          mountPath: /etc/config-logging
        resources:
          limits:
            cpu: 1000m
            memory: 1000Mi
          requests:
            cpu: 100m
            memory: 100Mi
        ports:
        - name: metrics
          containerPort: 9090
      volumes:
      - name: config-logging
        configMap:
          name: config-logging
      - name: google-cloud-key
        secret:
          secretName: google-cloud-key
      serviceAccount: controller
      terminationGracePeriodSeconds: 10

---
# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: admissionregistration.k8s.io/v1beta1
kind: MutatingWebhookConfiguration
metadata:
  name: webhook.events.cloud.google.com
  labels:
    events.cloud.google.com/release: "v0.13.0"
webhooks:
- admissionReviewVersions:
  - v1beta1
  clientConfig:
    service:
      name: webhook
      namespace: cloud-run-events
  failurePolicy: Fail
  sideEffects: None
  name: webhook.events.cloud.google.com
---
apiVersion: admissionregistration.k8s.io/v1beta1
kind: ValidatingWebhookConfiguration
metadata:
  name: validation.webhook.events.cloud.google.com
  labels:
    events.cloud.google.com/release: "v0.13.0"
webhooks:
- admissionReviewVersions:
  - v1beta1
  clientConfig:
    service:
      name: webhook
      namespace: cloud-run-events
  failurePolicy: Fail
  sideEffects: None
  name: validation.webhook.events.cloud.google.com
---
apiVersion: admissionregistration.k8s.io/v1beta1
kind: ValidatingWebhookConfiguration
metadata:
  name: config.webhook.events.cloud.google.com
  labels:
    events.cloud.google.com/release: "v0.13.0"
webhooks:
- admissionReviewVersions:
  - v1beta1
  clientConfig:
    service:
      name: webhook
      namespace: cloud-run-events
  failurePolicy: Fail
  sideEffects: None
  name: config.webhook.events.cloud.google.com
  namespaceSelector:
    matchExpressions:
    - key: events.cloud.google.com/release
      operator: Exists
---
apiVersion: v1
kind: Secret
metadata:
  name: webhook-certs
  namespace: cloud-run-events
  labels:
    events.cloud.google.com/release: "v0.13.0"
# The data is populated at install time.

---
# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: apps/v1
kind: Deployment
metadata:
  name: webhook
  namespace: cloud-run-events
  labels:
    events.cloud.google.com/release: "v0.13.0"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: cloud-run-events
      role: webhook
  template:
    metadata:
      labels:
        app: cloud-run-events
        role: webhook
        events.cloud.google.com/release: "v0.13.0"
    spec:
      serviceAccountName: webhook
      containers:
      - name: webhook
        terminationMessagePolicy: FallbackToLogsOnError
        # This is the Go import path for the binary that is containerized
        # and substituted here.
        image: gcr.io/knative-releases/github.com/google/knative-gcp/cmd/webhook@sha256:666b4826d251938eddbd62986f260687b71b0f86d5c9dc784437471a868d9e90
        resources:
          requests:
            # taken from serving.
            cpu: 20m
            memory: 20Mi
          limits:
            # taken from serving.
            cpu: 200m
            memory: 200Mi
        env:
        - name: SYSTEM_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: CONFIG_LOGGING_NAME
          value: config-logging
        - name: METRICS_DOMAIN
          value: cloud.google.com/events
        - name: WEBHOOK_NAME
          value: webhook

---
# Copyright 2020 The Knative Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: v1
kind: ConfigMap
metadata:
  name: config-leader-election
  namespace: cloud-run-events
  labels:
    events.cloud.google.com/release: "v0.13.0"
data:
  # An inactive but valid configuration follows; see example.
  resourceLock: "leases"
  leaseDuration: "15s"
  renewDeadline: "10s"
  retryPeriod: "2s"
  _example: |
    ################################
    #                              #
    #    EXAMPLE CONFIGURATION     #
    #                              #
    ################################
    # This block is not actually functional configuration,
    # but serves to illustrate the available configuration
    # options and document them in a way that is accessible
    # to users that `kubectl edit` this config map.
    #
    # These sample configuration options may be copied out of
    # this example block and unindented to be in the data block
    # to actually change the configuration.
    # resourceLock controls which API resource is used as the basis for the
    # leader election lock. Valid values are:
    #
    # - leases -> use the coordination API
    # - configmaps -> use configmaps
    # - endpoints -> use endpoints
    resourceLock: "leases"
    # leaseDuration is how long non-leaders will wait to try to acquire the
    # lock; 15 seconds is the value used by core kubernetes controllers.
    leaseDuration: "15s"
    # renewDeadline is how long a leader will try to renew the lease before
    # giving up; 10 seconds is the value used by core kubernetes controllers.
    renewDeadline: "10s"
    # retryPeriod is how long the leader election client waits between tries of
    # actions; 2 seconds is the value used by core kuberntes controllers.
    retryPeriod: "2s"
    # enabledComponents is a comma-delimited list of component names for which
    # leader election is enabled. Valid values are:
    #
    # - controller
    enabledComponents: "controller"

---
# Copyright 2018 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: v1
kind: ConfigMap
metadata:
  name: config-logging
  namespace: cloud-run-events
  labels:
    events.cloud.google.com/release: "v0.13.0"
data:
  _example: |
    ################################
    #                              #
    #    EXAMPLE CONFIGURATION     #
    #                              #
    ################################

    # This block is not actually functional configuration,
    # but serves to illustrate the available configuration
    # options and document them in a way that is accessible
    # to users that `kubectl edit` this config map.
    #
    # These sample configuration options may be copied out of
    # this example block and unindented to be in the data block
    # to actually change the configuration.

    # Common configuration for all Knative codebase
    zap-logger-config: |
      {
        "level": "info",
        "development": false,
        "outputPaths": ["stdout"],
        "errorOutputPaths": ["stderr"],
        "encoding": "json",
        "encoderConfig": {
          "timeKey": "ts",
          "levelKey": "level",
          "nameKey": "logger",
          "callerKey": "caller",
          "messageKey": "msg",
          "stacktraceKey": "stacktrace",
          "lineEnding": "",
          "levelEncoder": "",
          "timeEncoder": "iso8601",
          "durationEncoder": "",
          "callerEncoder": ""
        }
      }

    # Log level overrides
    # For all components except the autoscaler and queue proxy,
    # changes are be picked up immediately.
    # For autoscaler and queue proxy, changes require recreation of the pods.
    loglevel.controller: "info"
    loglevel.autoscaler: "info"
    loglevel.queueproxy: "info"
    loglevel.webhook: "info"
    loglevel.activator: "info"

---
# Copyright 2019 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: v1
kind: ConfigMap
metadata:
  name: config-observability
  namespace: cloud-run-events
  labels:
    events.cloud.google.com/release: "v0.13.0"
data:
  _example: |
    ################################
    #                              #
    #    EXAMPLE CONFIGURATION     #
    #                              #
    ################################

    # This block is not actually functional configuration,
    # but serves to illustrate the available configuration
    # options and document them in a way that is accessible
    # to users that `kubectl edit` this config map.
    #
    # These sample configuration options may be copied out of
    # this example block and unindented to be in the data block
    # to actually change the configuration.

    # metrics.backend-destination field specifies the system metrics destination.
    # It supports either prometheus (the default) or stackdriver.
    # Note: Using stackdriver will incur additional charges
    metrics.backend-destination: prometheus

    # metrics.stackdriver-project-id field specifies the stackdriver project ID. This
    # field is optional. When running on GCE, application default credentials will be
    # used if this field is not provided.
    metrics.stackdriver-project-id: "<your stackdriver project id>"

    # metrics.allow-stackdriver-custom-metrics indicates whether it is allowed to send metrics to
    # Stackdriver using "global" resource type and custom metric type if the
    # metrics are not supported by "knative_source" resource type. Setting this
    # flag to "true" could cause extra Stackdriver charge.
    # If metrics.backend-destination is not Stackdriver, this is ignored.
    metrics.allow-stackdriver-custom-metrics: "false"

    # stackdriver-custom-metrics-subdomain is the subdomain to use when sending custom metrics to StackDriver.
    # If not specified, the default is set to "knative.dev".
    # If metrics.backend-destination is not Stackdriver, this is ignored.
    metrics.stackdriver-custom-metrics-subdomain: "<your subdomain>"

---
# Copyright 2019 The Knative Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

apiVersion: v1
kind: ConfigMap
metadata:
  name: config-tracing
  namespace: cloud-run-events
data:
  _example: |
    ################################
    #                              #
    #    EXAMPLE CONFIGURATION     #
    #                              #
    ################################
    # This block is not actually functional configuration,
    # but serves to illustrate the available configuration
    # options and document them in a way that is accessible
    # to users that `kubectl edit` this config map.
    #
    # These sample configuration options may be copied out of
    # this example block and unindented to be in the data block
    # to actually change the configuration.
    #
    # This may be "zipkin" or "stackdriver", the default is "none"
    backend: "none"

    # URL to zipkin collector where traces are sent.
    # This must be specified when backend is "zipkin"
    zipkin-endpoint: "http://zipkin.istio-system.svc.cluster.local:9411/api/v2/spans"

    # The GCP project into which stackdriver metrics will be written
    # when backend is "stackdriver".  If unspecified, the project-id
    # is read from GCP metadata when running on GCP.
    stackdriver-project-id: "my-project"

    # Enable zipkin debug mode. This allows all spans to be sent to the server
    # bypassing sampling.
    debug: "false"

    # Percentage (0-1) of requests to trace
    sample-rate: "0.1"

---
